<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>field</title>
</head>
<body>
    <canvas id='mainCanvas' width="500" height="500"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/victor/1.1.0/victor.js"> </script>
    <script>
        const canv = document.getElementById('mainCanvas')
        const ctx = canv.getContext('2d')
        const canvasSize = canv.width

        ctx.fillStyle = 'black'
        ctx.fillRect(0, 0, canvasSize, canvasSize)

        class Source extends Victor {
            constructor(x, y, c) {
                super()
                this.x = x;
                this.y = y;
                this.charge = c
            }
            potentialAt(x, y) { 
                return this.charge * canvasSize / this.distance(new Victor(x, y))
            }
            draw() {
                const  { x, y, charge } = this
                const size = Math.abs(charge)

                ctx.fillStyle = charge > 0 ? 'blue' : 'red'
                ctx.beginPath()
                ctx.arc(x , y, size, 0, 2 * Math.PI)
                ctx.fill()
            }
        }

        const sources = [
            new Source(220, 350, 1),
            new Source(1, 1, 1),
            new Source(305, 255, -1),
        ]

        // CALCILATE POTENTIAL
        const potential = Array(canvasSize).fill({}).map(o => new Array(canvasSize))
        let maxPotential = 1
        let minPotential = -1

        for (let x = 0; x < canvasSize; x++){
            for (let y = 0; y < canvasSize; y++){
                potential[x][y] = sources.reduce((acc, source) => { 
                    return acc + source.potentialAt(x, y)
                }, 0)

                if (potential[x][y] === Infinity ||
                potential[x][y] === -Infinity) continue

                // maxPotential = Math.max(maxPotential, potential[x][y])
                // minPotential = Math.min(minPotential, potential[x][y])

                if (maxPotential < potential[x][y]) {
                    maxPotential = potential[x][y]
                }

                if (minPotential> potential[x][y]) {
                    minPotential = potential[x][y]
                }

            }
        }

        console.log(minPotential, maxPotential);
        console.log(potential)

        //NORMALIZE POTENTIAL
        for (let x = 0; x < canvasSize; x++){
            for (let y = 0; y < canvasSize; y++){
                // potential[x][y] = potential[x][y] / maxPotential * 255
                potential[x][y] = 255 * Math.log2(1 + potential[x][y] / maxPotential)
            }
        }

        console.log(potential);

        // DRAW POTENTIAL
        for (let x = 0; x < canvasSize; x++){
            for (let y = 0; y < canvasSize; y++){
                ctx.fillStyle = `rgb(0, ${potential[x][y]} , 0)`
                ctx.fillRect(x, y, 1, 1)
            }
        }
        
        // DRAW SOURCES
        sources.forEach(source => source.draw())

    </script>

</body>
</html>